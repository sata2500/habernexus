# =============================================================================
# HaberNexus - Pull Request Automation
# Automatically manages PRs: reviews, reminders, auto-merge
# Author: Salih TANRISEVEN
# Updated: December 2025
# =============================================================================

name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, review_requested]
  pull_request_review:
    types: [submitted]
  schedule:
    # Her gÃ¼n saat 10:00 ve 16:00 UTC'de Ã§alÄ±ÅŸ
    - cron: '0 10,16 * * *'
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write
  issues: write

env:
  OWNER: sata2500

jobs:
  # ===========================================================================
  # Welcome New Contributors
  # ===========================================================================
  welcome:
    name: Welcome New Contributors
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'

    steps:
      - name: Check if first contribution
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          # KullanÄ±cÄ±nÄ±n Ã¶nceki PR'larÄ±nÄ± kontrol et
          PR_COUNT=$(gh pr list \
            --repo ${{ github.repository }} \
            --author "$AUTHOR" \
            --state all \
            --json number \
            --jq 'length')
          
          if [ "$PR_COUNT" -le 1 ]; then
            echo "is_first=true" >> $GITHUB_OUTPUT
          else
            echo "is_first=false" >> $GITHUB_OUTPUT
          fi

      - name: Welcome first-time contributor
        if: steps.check.outputs.is_first == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          gh pr comment $PR_NUMBER --body "ğŸ‰ Merhaba @$AUTHOR!

          HaberNexus'a ilk katkÄ±nÄ±z iÃ§in teÅŸekkÃ¼rler! 

          **Ä°nceleme SÃ¼reci:**
          1. CI kontrolleri otomatik Ã§alÄ±ÅŸacak
          2. Kod incelemesi yapÄ±lacak
          3. Gerekirse deÄŸiÅŸiklik talep edilecek
          4. OnaylandÄ±ktan sonra merge edilecek

          **YararlÄ± BaÄŸlantÄ±lar:**
          - ğŸ“– [KatkÄ± Rehberi](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)
          - ğŸ› ï¸ [GeliÅŸtirici Rehberi](https://github.com/${{ github.repository }}/blob/main/DEVELOPER_GUIDE.md)

          SorularÄ±nÄ±z varsa Ã§ekinmeden sorun!

          > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."

  # ===========================================================================
  # Auto Request Review
  # ===========================================================================
  auto-request-review:
    name: Auto Request Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'ready_for_review'

    steps:
      - name: Request review from maintainer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          # Yazar maintainer deÄŸilse review iste
          if [ "$AUTHOR" != "${{ env.OWNER }}" ]; then
            gh pr edit $PR_NUMBER --add-reviewer "${{ env.OWNER }}" || true
            echo "Requested review from ${{ env.OWNER }}"
          fi

  # ===========================================================================
  # Review Reminder
  # ===========================================================================
  review-reminder:
    name: Review Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Find PRs waiting for review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 2 gÃ¼nden eski review bekleyen PR'larÄ± bul
          WAITING_PRS=$(gh pr list \
            --repo ${{ github.repository }} \
            --state open \
            --json number,title,createdAt,author,reviewRequests \
            --jq '[.[] | select(.reviewRequests | length > 0) | select((now - (.createdAt | fromdateiso8601)) > 172800)] | .[0:5]')
          
          if [ "$WAITING_PRS" != "[]" ] && [ -n "$WAITING_PRS" ]; then
            echo "Found PRs waiting for review"
            
            echo "$WAITING_PRS" | jq -r '.[].number' | while read PR_NUM; do
              if [ -n "$PR_NUM" ]; then
                gh pr comment $PR_NUM --body "â° **Review HatÄ±rlatmasÄ±**

                Bu PR 2 gÃ¼nden fazla sÃ¼redir review bekliyor.

                @${{ env.OWNER }} lÃ¼tfen incelemeyi tamamlayÄ±n.

                > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."
              fi
            done
          fi

  # ===========================================================================
  # Auto Merge Dependabot PRs
  # ===========================================================================
  auto-merge-dependabot:
    name: Auto Merge Dependabot
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'opened' &&
      github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Enable auto-merge for Dependabot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Sadece minor ve patch gÃ¼ncellemeler iÃ§in auto-merge
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          if echo "$PR_TITLE" | grep -iE "bump.*from [0-9]+\.[0-9]+\.[0-9]+ to [0-9]+\.[0-9]+\.[0-9]+" > /dev/null; then
            # Auto-merge etkinleÅŸtir (squash merge)
            gh pr merge $PR_NUMBER --auto --squash || true
            echo "Auto-merge enabled for Dependabot PR #$PR_NUMBER"
          fi

  # ===========================================================================
  # Notify on Review Submission
  # ===========================================================================
  notify-review:
    name: Notify on Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review'

    steps:
      - name: Notify PR author
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REVIEWER="${{ github.event.review.user.login }}"
          REVIEW_STATE="${{ github.event.review.state }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          case "$REVIEW_STATE" in
            "approved")
              MESSAGE="âœ… @$AUTHOR, PR'Ä±nÄ±z @$REVIEWER tarafÄ±ndan onaylandÄ±! ğŸ‰"
              ;;
            "changes_requested")
              MESSAGE="ğŸ“ @$AUTHOR, @$REVIEWER deÄŸiÅŸiklik talep etti. LÃ¼tfen inceleyin."
              ;;
            "commented")
              MESSAGE="ğŸ’¬ @$AUTHOR, @$REVIEWER yorum ekledi."
              ;;
            *)
              exit 0
              ;;
          esac
          
          gh pr comment $PR_NUMBER --body "$MESSAGE

          > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."

  # ===========================================================================
  # PR Size Labeler
  # ===========================================================================
  size-labeler:
    name: PR Size Labeler
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')

    steps:
      - name: Label PR by size
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          ADDITIONS="${{ github.event.pull_request.additions }}"
          DELETIONS="${{ github.event.pull_request.deletions }}"
          
          TOTAL=$((ADDITIONS + DELETIONS))
          
          # Mevcut size etiketlerini kaldÄ±r
          gh pr edit $PR_NUMBER --remove-label "size/XS,size/S,size/M,size/L,size/XL" 2>/dev/null || true
          
          # Boyuta gÃ¶re etiket ekle
          if [ $TOTAL -lt 10 ]; then
            LABEL="size/XS"
          elif [ $TOTAL -lt 50 ]; then
            LABEL="size/S"
          elif [ $TOTAL -lt 200 ]; then
            LABEL="size/M"
          elif [ $TOTAL -lt 500 ]; then
            LABEL="size/L"
          else
            LABEL="size/XL"
          fi
          
          gh pr edit $PR_NUMBER --add-label "$LABEL" || true
          echo "Added label: $LABEL (total changes: $TOTAL)"

  # ===========================================================================
  # Conflict Checker
  # ===========================================================================
  conflict-checker:
    name: Conflict Checker
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Check for merge conflicts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Merge conflict olan PR'larÄ± bul
          CONFLICT_PRS=$(gh pr list \
            --repo ${{ github.repository }} \
            --state open \
            --json number,mergeable,author \
            --jq '[.[] | select(.mergeable == "CONFLICTING")] | .[0:5]')
          
          if [ "$CONFLICT_PRS" != "[]" ] && [ -n "$CONFLICT_PRS" ]; then
            echo "Found PRs with conflicts"
            
            echo "$CONFLICT_PRS" | jq -c '.[]' | while read PR; do
              PR_NUM=$(echo "$PR" | jq -r '.number')
              AUTHOR=$(echo "$PR" | jq -r '.author.login')
              
              if [ -n "$PR_NUM" ]; then
                gh pr comment $PR_NUM --body "âš ï¸ **Merge Conflict Tespit Edildi**

                @$AUTHOR, bu PR'da merge conflict var. LÃ¼tfen Ã§Ã¶zÃ¼n:

                \`\`\`bash
                git fetch origin
                git checkout your-branch
                git merge origin/main
                # Conflict'leri Ã§Ã¶zÃ¼n
                git add .
                git commit -m \"Resolve merge conflicts\"
                git push
                \`\`\`

                > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."
              fi
            done
          fi
