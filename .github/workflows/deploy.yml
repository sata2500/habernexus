# =============================================================================
# HaberNexus - CD Pipeline
# Continuous Deployment to production server
# Author: Salih TANRISEVEN
# Updated: December 2025
# =============================================================================

name: CD Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  deployments: write
  id-token: write

env:
  DOMAIN: habernexus.com

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      secrets_configured: ${{ steps.check_secrets.outputs.configured }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check if secrets are configured
      id: check_secrets
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_USER: ${{ secrets.VM_USER }}
        VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
        DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        MISSING_SECRETS=""
        CONFIGURED="true"
        
        if [ -z "$VM_HOST" ]; then
          MISSING_SECRETS="${MISSING_SECRETS}VM_HOST, "
          CONFIGURED="false"
        fi
        if [ -z "$VM_USER" ]; then
          MISSING_SECRETS="${MISSING_SECRETS}VM_USER, "
          CONFIGURED="false"
        fi
        if [ -z "$VM_SSH_KEY" ]; then
          MISSING_SECRETS="${MISSING_SECRETS}VM_SSH_KEY, "
          CONFIGURED="false"
        fi
        if [ -z "$DJANGO_SECRET_KEY" ]; then
          MISSING_SECRETS="${MISSING_SECRETS}DJANGO_SECRET_KEY, "
          CONFIGURED="false"
        fi
        if [ -z "$DB_PASSWORD" ]; then
          MISSING_SECRETS="${MISSING_SECRETS}DB_PASSWORD, "
          CONFIGURED="false"
        fi
        
        echo "configured=$CONFIGURED" >> $GITHUB_OUTPUT
        
        if [ "$CONFIGURED" = "false" ]; then
          echo "âš ï¸ Missing secrets: ${MISSING_SECRETS%,*}"
          echo "::notice::Deployment secrets are not fully configured. Please configure the following secrets in repository settings: ${MISSING_SECRETS%,*}"
          echo ""
          echo "ðŸ“ Required secrets for deployment:"
          echo "  - VM_HOST: Your server IP or hostname"
          echo "  - VM_USER: SSH username for deployment"
          echo "  - VM_SSH_KEY: Private SSH key for authentication"
          echo "  - DJANGO_SECRET_KEY: Django secret key for production"
          echo "  - DB_PASSWORD: Database password"
          echo ""
          echo "ðŸ”— Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
        else
          echo "âœ… All required secrets are configured"
        fi

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Validate Django settings
      env:
        DJANGO_SETTINGS_MODULE: habernexus_config.settings_test
      run: |
        python manage.py check --deploy 2>&1 || echo "::notice::Some Django deployment checks need attention. Review before production deployment."

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.secrets_configured == 'true'
    environment:
      name: production
      url: https://habernexus.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment
      uses: actions/github-script@v7
      id: deployment
      with:
        script: |
          const deployment = await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.ref,
            environment: 'production',
            required_contexts: [],
            auto_merge: false
          });
          return deployment.data.id;

    - name: Create .env file
      run: |
        cat > .env << 'ENVEOF'
        DEBUG=False
        ALLOWED_HOSTS=${{ vars.ALLOWED_HOSTS || 'habernexus.com,www.habernexus.com' }}
        DB_ENGINE=django.db.backends.postgresql
        DB_HOST=postgres
        DB_NAME=${{ vars.DB_NAME || 'habernexus' }}
        DB_USER=${{ vars.DB_USER || 'habernexus' }}
        DB_PORT=${{ vars.DB_PORT || '5432' }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        SECURE_SSL_REDIRECT=True
        SESSION_COOKIE_SECURE=True
        CSRF_COOKIE_SECURE=True
        DOMAIN=${{ vars.DOMAIN || 'habernexus.com' }}
        DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
        CELERY_BROKER_URL=${{ vars.CELERY_BROKER_URL || 'redis://redis:6379/0' }}
        CELERY_RESULT_BACKEND=${{ vars.CELERY_RESULT_BACKEND || 'redis://redis:6379/0' }}
        GOOGLE_GEMINI_API_KEY=${{ secrets.GOOGLE_GEMINI_API_KEY }}
        ENVEOF
        chmod 600 .env

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Backup database before deployment
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
          "cd /opt/habernexus && bash scripts/backup.sh" || echo "::notice::Backup warning - continuing deployment"
      continue-on-error: true

    - name: Copy .env file to VM
      run: |
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no .env ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:/opt/habernexus/.env

    - name: Deploy via SSH
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'DEPLOY_SCRIPT'
        set -e
        cd /opt/habernexus
        
        echo "ðŸ“¥ Fetching latest code..."
        git fetch origin
        git reset --hard origin/main
        
        echo "ðŸ³ Stopping containers..."
        docker-compose -f docker-compose.prod.yml down -v --remove-orphans || true
        
        echo "ðŸ”¨ Building and starting containers..."
        docker-compose -f docker-compose.prod.yml up -d --build
        
        echo "â³ Waiting for services to start..."
        sleep 30
        
        echo "ðŸ”„ Running migrations..."
        for i in {1..5}; do
          if docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput; then
            echo "âœ… Migrations completed successfully"
            break
          fi
          if [ $i -lt 5 ]; then
            echo "âš ï¸ Migration attempt $i failed, retrying in 10s..."
            sleep 10
          else
            echo "âŒ Migrations failed after 5 attempts"
            exit 1
          fi
        done
        
        echo "ðŸ“¦ Collecting static files..."
        docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
        
        echo "âœ… Deployment completed successfully"
        DEPLOY_SCRIPT

    - name: Health check
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
          "cd /opt/habernexus && bash scripts/health-check.sh" || echo "::notice::Health check returned warnings"

    - name: Create deployment status - success
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: ${{ steps.deployment.outputs.result }},
            state: 'success',
            environment_url: 'https://habernexus.com',
            description: 'Deployment successful'
          });

    - name: Create deployment status - failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: ${{ steps.deployment.outputs.result }},
            state: 'failure',
            description: 'Deployment failed'
          });

    - name: Notify Slack on success
      if: success()
      uses: slackapi/slack-github-action@v2.1.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "âœ… Deployment to https://habernexus.com successful!",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment Successful* âœ…\n*Repository:* ${{ github.repository }}\n*Commit:* ${{ github.sha }}\n*URL:* https://habernexus.com"
                }
              }
            ]
          }
      continue-on-error: true

    - name: Notify Slack on failure
      if: failure()
      uses: slackapi/slack-github-action@v2.1.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "âŒ Deployment to https://habernexus.com failed!",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment Failed* âŒ\n*Repository:* ${{ github.repository }}\n*Commit:* ${{ github.sha }}\n*Check logs:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              }
            ]
          }
      continue-on-error: true

  skip-deploy:
    name: Skip Deployment (Secrets Not Configured)
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.secrets_configured != 'true'
    
    steps:
    - name: Deployment skipped
      run: |
        echo "âš ï¸ Deployment was skipped because required secrets are not configured."
        echo ""
        echo "ðŸ“ To enable automatic deployment, please configure the following secrets:"
        echo "  - VM_HOST: Your server IP or hostname"
        echo "  - VM_USER: SSH username for deployment"
        echo "  - VM_SSH_KEY: Private SSH key for authentication"
        echo "  - DJANGO_SECRET_KEY: Django secret key for production"
        echo "  - DB_PASSWORD: Database password"
        echo ""
        echo "ðŸ”— Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
        echo ""
        echo "ðŸ“– For manual deployment instructions, see: docs/DEPLOYMENT.md"
