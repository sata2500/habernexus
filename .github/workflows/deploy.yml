name: CD Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://habernexus.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate secrets
      run: |
        if [ -z "${{ secrets.VM_HOST }}" ]; then echo "VM_HOST secret is not set"; exit 1; fi
        if [ -z "${{ secrets.VM_USER }}" ]; then echo "VM_USER secret is not set"; exit 1; fi
        if [ -z "${{ secrets.VM_SSH_KEY }}" ]; then echo "VM_SSH_KEY secret is not set"; exit 1; fi
        if [ -z "${{ secrets.DJANGO_SECRET_KEY }}" ]; then echo "DJANGO_SECRET_KEY secret is not set"; exit 1; fi
        if [ -z "${{ secrets.DB_PASSWORD }}" ]; then echo "DB_PASSWORD secret is not set"; exit 1; fi
        if [ -z "${{ secrets.GOOGLE_GEMINI_API_KEY }}" ]; then echo "GOOGLE_GEMINI_API_KEY secret is not set"; exit 1; fi

    - name: Create .env file
      run: |
        echo "DEBUG=False" > .env
        echo "ALLOWED_HOSTS=${{ vars.ALLOWED_HOSTS }}" >> .env
        echo "DB_ENGINE=django.db.backends.postgresql" >> .env
        echo "DB_HOST=postgres" >> .env
        echo "SECURE_SSL_REDIRECT=True" >> .env
        echo "SESSION_COOKIE_SECURE=True" >> .env
        echo "CSRF_COOKIE_SECURE=True" >> .env
        echo "DOMAIN=${{ vars.DOMAIN }}" >> .env
        echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> .env
        echo "DB_NAME=${{ vars.DB_NAME }}" >> .env
        echo "DB_USER=${{ vars.DB_USER }}" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
        echo "DB_PORT=${{ vars.DB_PORT }}" >> .env
        echo "CELERY_BROKER_URL=${{ vars.CELERY_BROKER_URL }}" >> .env
        echo "CELERY_RESULT_BACKEND=${{ vars.CELERY_RESULT_BACKEND }}" >> .env
        echo "GOOGLE_GEMINI_API_KEY=${{ secrets.GOOGLE_GEMINI_API_KEY }}" >> .env

    - name: Backup database before deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd /opt/habernexus
          bash scripts/backup.sh

    - name: Copy .env file to VM
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        source: ".env"
        target: "/opt/habernexus/.env"

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          set -e
          cd /opt/habernexus
          git fetch origin
          git reset --hard origin/main
          docker-compose -f docker-compose.prod.yml down -v --remove-orphans || true
          docker-compose -f docker-compose.prod.yml up -d --build
          sleep 20
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput

    - name: Health check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd /opt/habernexus
          bash scripts/health-check.sh

    - name: Notify Slack on success
      if: success()
      uses: slackapi/slack-github-action@v1
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "✅ Deployment to https://habernexus.com successful!"
          }

    - name: Notify Slack on failure
      if: failure()
      uses: slackapi/slack-github-action@v1
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "❌ Deployment to https://habernexus.com failed!"
          }
