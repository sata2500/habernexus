name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Google Cloud VM
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cat > /tmp/.env << 'DOTENV'
        DEBUG=False
        ALLOWED_HOSTS=habernexus.com,www.habernexus.com,35.198.132.19,localhost,127.0.0.1
        DB_ENGINE=django.db.backends.postgresql
        DB_HOST=postgres
        SECURE_SSL_REDIRECT=True
        SESSION_COOKIE_SECURE=True
        CSRF_COOKIE_SECURE=True
        SECURE_HSTS_SECONDS=31536000
        SECURE_HSTS_INCLUDE_SUBDOMAINS=True
        SECURE_HSTS_PRELOAD=True
        DOMAIN=habernexus.com
        MEDIA_ROOT=/media
        STATIC_ROOT=/static
        DOTENV
        echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> /tmp/.env
        echo "DB_NAME=${{ vars.DB_NAME }}" >> /tmp/.env
        echo "DB_USER=${{ vars.DB_USER }}" >> /tmp/.env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> /tmp/.env
        echo "DB_PORT=${{ vars.DB_PORT }}" >> /tmp/.env
        echo "CELERY_BROKER_URL=${{ vars.CELERY_BROKER_URL }}" >> /tmp/.env
        echo "CELERY_RESULT_BACKEND=${{ vars.CELERY_RESULT_BACKEND }}" >> /tmp/.env
        echo "GOOGLE_GEMINI_API_KEY=${{ secrets.GOOGLE_GEMINI_API_KEY }}" >> /tmp/.env
        echo "AI_MODEL=${{ vars.AI_MODEL }}" >> /tmp/.env
        echo "IMAGE_MODEL=${{ vars.IMAGE_MODEL }}" >> /tmp/.env
        echo "VIDEO_MODEL=${{ vars.VIDEO_MODEL }}" >> /tmp/.env

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        script: |
          set -e
          echo "=== Starting deployment ==="
          cd /opt/habernexus
          
          git fetch origin
          git reset --hard origin/main
          
          docker-compose -f docker-compose.prod.yml build
          docker-compose -f docker-compose.prod.yml down || true
          docker-compose -f docker-compose.prod.yml up -d
          
          sleep 20
          
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
          
          sleep 15
          
          if curl -f http://localhost:8000/health/; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed"
            docker-compose -f docker-compose.prod.yml logs web
            exit 1
          fi

    - name: Copy .env file to VM
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        source: "/tmp/.env"
        target: "/opt/habernexus/.env"

    - name: Deployment Success
      if: success()
      run: echo "✅ Deployment completed successfully!"

    - name: Deployment Failure
      if: failure()
      run: echo "❌ Deployment failed!"
