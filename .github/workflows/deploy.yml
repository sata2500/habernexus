name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Google Cloud VM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        script: |
          set -e
          
          echo "=== Starting deployment ==="
          cd /opt/habernexus
          
          # Pull latest code
          echo "Pulling latest code from GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          # Build and start containers
          echo "Building Docker images..."
          docker-compose -f docker-compose.prod.yml build
          
          # Stop old containers
          echo "Stopping old containers..."
          docker-compose -f docker-compose.prod.yml down || true
          
          # Start new containers
          echo "Starting new containers..."
          docker-compose -f docker-compose.prod.yml up -d
          
          # Wait for services to be ready
          echo "Waiting for services to be ready..."
          sleep 20
          
          # Run migrations
          echo "Running database migrations..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate
          
          # Collect static files
          echo "Collecting static files..."
          docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput
          
          # Health check
          echo "Waiting for application to be ready..."
          sleep 15
          
          for i in {1..60}; do
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:8000/health/ | grep -q "200"; then
              echo "✅ Application is healthy!"
              break
            fi
            echo "Waiting for application... ($i/60)"
            sleep 2
          done
          
          # Verify deployment
          if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:8000/health/ | grep -q "200"; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed - application not responding"
            docker-compose -f docker-compose.prod.yml logs web
            exit 1
          fi

    - name: Deployment Success Notification
      if: success()
      run: |
        echo "✅ Deployment to production completed successfully!"
        echo "Application is now live at https://habernexus.com"

    - name: Deployment Failure Notification
      if: failure()
      run: |
        echo "❌ Deployment to production failed!"
        echo "Please check the logs above for details."
