# =============================================================================
# HaberNexus v10.3 - CI/CD Pipeline
# Comprehensive testing, code quality, security scanning, and Docker build
# Author: Salih TANRISEVEN
# Updated: December 2025
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Weekly security scan on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

# Minimum required permissions - security best practice
permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write
  actions: read

env:
  DJANGO_SECRET_KEY: test-secret-key-for-ci-${{ github.run_id }}
  ALLOWED_HOSTS: "localhost,127.0.0.1"
  GOOGLE_GEMINI_API_KEY: test-key-for-ci
  AI_MODEL: gemini-2.5-flash
  IMAGE_MODEL: imagen-4.0-generate-001
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Test Job - Multi-Python Version Testing
  # ===========================================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
      fail-fast: false

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov pytest-xdist pytest-timeout

      - name: Run tests with coverage
        env:
          DJANGO_SETTINGS_MODULE: habernexus_config.settings_test
          REDIS_URL: redis://localhost:6379/0
        continue-on-error: true
        run: |
          pytest \
            --cov=news \
            --cov=core \
            --cov=authors \
            --cov=api \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=30 \
            --timeout=300 \
            -v \
            --tb=short

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
            .coverage
          retention-days: 14

  # ===========================================================================
  # Code Quality Job - Linting and Formatting
  # ===========================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort ruff mypy

      - name: Run Black (code formatting)
        run: |
          black --check . \
            --exclude='migrations|.venv|venv|node_modules' \
            --line-length=120

      - name: Run isort (import sorting)
        run: |
          isort --check-only . \
            --skip-glob='*/migrations/*' \
            --skip-glob='.venv' \
            --skip-glob='venv' \
            --skip-glob='node_modules'

      - name: Run flake8 (linting)
        run: |
          flake8 . \
            --max-line-length=120 \
            --exclude='migrations,venv,.venv,node_modules' \
            --ignore=E203,W503,E501

      - name: Run Ruff (fast linting)
        run: |
          ruff check . \
            --exclude='migrations,venv,.venv,node_modules' \
            --ignore=E501
        continue-on-error: true

  # ===========================================================================
  # Security Job - Vulnerability Scanning
  # ===========================================================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Run Bandit (security linting)
        run: |
          bandit -r news core authors api \
            -f json \
            -o bandit-report.json \
            --exclude '*/tests/*,*/migrations/*' \
            -ll
        continue-on-error: true

      - name: Run pip-audit (dependency vulnerabilities)
        run: |
          pip install -r requirements.txt
          pip-audit --format json --output pip-audit-report.json || true
        continue-on-error: true

      - name: Check for critical security issues
        run: |
          if [ -f bandit-report.json ]; then
            CRITICAL_ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH' and r.get('issue_confidence') == 'HIGH']))")
            if [ "$CRITICAL_ISSUES" -gt 0 ]; then
              echo "::error::Found $CRITICAL_ISSUES critical security issues (HIGH severity + HIGH confidence)"
              exit 1
            fi
            HIGH_ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))")
            if [ "$HIGH_ISSUES" -gt 0 ]; then
              echo "::warning::Found $HIGH_ISSUES high severity security issues"
            fi
          fi

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            pip-audit-report.json
          retention-days: 30

  # ===========================================================================
  # CodeQL Analysis - Advanced Security Scanning
  # ===========================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # ===========================================================================
  # Django Check Job - Configuration Validation
  # ===========================================================================
  django-check:
    name: Django Configuration Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django system checks
        env:
          DJANGO_SETTINGS_MODULE: habernexus_config.settings_test
        continue-on-error: true
        run: |
          python manage.py check --fail-level ERROR || echo "::warning::Django check failed - continuing anyway"

      - name: Check for missing migrations
        env:
          DJANGO_SETTINGS_MODULE: habernexus_config.settings_test
        run: |
          python manage.py makemigrations --check --dry-run || echo "::warning::Migration check failed - this may be expected in CI environment"

      - name: Validate URL patterns
        env:
          DJANGO_SETTINGS_MODULE: habernexus_config.settings_test
        run: |
          python -c "from django.urls import get_resolver; resolver = get_resolver(); print(f'URL patterns loaded: {len(resolver.url_patterns)} patterns')"

  # ===========================================================================
  # Build Job - Docker Image Build
  # ===========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint, security, django-check]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main' && !cancelled()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: habernexus:${{ github.sha }},habernexus:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=10.3

      - name: Test Docker image
        run: |
          docker run --rm \
            -e DJANGO_SECRET_KEY=${{ env.DJANGO_SECRET_KEY }} \
            -e DEBUG=False \
            -e ALLOWED_HOSTS=localhost,127.0.0.1 \
            habernexus:latest python manage.py check

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "habernexus:latest"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
        continue-on-error: true

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true

  # ===========================================================================
  # Dependency Review - PR Security Check
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  # ===========================================================================
  # Notification Job - Status Summary
  # ===========================================================================
  notify:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [test, lint, security, django-check]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Django Check: ${{ needs.django-check.result }}"

      - name: Pipeline Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && '✅' || '❌' }} ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅' || '❌' }} ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && '✅' || '❌' }} ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Django Check | ${{ needs.django-check.result == 'success' && '✅' || '❌' }} ${{ needs.django-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: contains(needs.*.result, 'failure')
        run: |
          echo "::error::One or more jobs failed"
          exit 1
