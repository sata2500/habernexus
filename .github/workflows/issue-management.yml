# =============================================================================
# HaberNexus - Automated Issue Management
# Automatically manages issues: labels, assignments, and notifications
# Author: Salih TANRISEVEN
# Updated: December 2025
# =============================================================================

name: Issue Management

on:
  issues:
    types: [opened, edited, labeled, unlabeled, assigned, unassigned]
  issue_comment:
    types: [created]
  schedule:
    # Her gÃ¼n saat 09:00 UTC'de Ã§alÄ±ÅŸ (TÃ¼rkiye saati 12:00)
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

env:
  OWNER: sata2500

jobs:
  # ===========================================================================
  # Auto Label New Issues
  # ===========================================================================
  auto-label:
    name: Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze issue and add labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # BaÅŸlÄ±k ve iÃ§erik analizi ile otomatik etiketleme
          LABELS=""
          
          # Bug tespiti
          if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -iE "bug|hata|error|crash|fail|broken|fix" > /dev/null; then
            LABELS="$LABELS,bug"
          fi
          
          # Feature request tespiti
          if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -iE "feature|Ã¶zellik|enhancement|improve|add|ekle|yeni" > /dev/null; then
            LABELS="$LABELS,enhancement"
          fi
          
          # Documentation tespiti
          if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -iE "doc|documentation|readme|dÃ¶kÃ¼man|belge" > /dev/null; then
            LABELS="$LABELS,documentation"
          fi
          
          # Security tespiti
          if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -iE "security|gÃ¼venlik|vulnerability|exploit|cve" > /dev/null; then
            LABELS="$LABELS,security,priority: high"
          fi
          
          # Question tespiti
          if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -iE "question|soru|how|nasÄ±l|\?" > /dev/null; then
            LABELS="$LABELS,question"
          fi
          
          # Etiketleri ekle
          if [ -n "$LABELS" ]; then
            LABELS=$(echo "$LABELS" | sed 's/^,//')
            gh issue edit $ISSUE_NUMBER --add-label "$LABELS"
            echo "Added labels: $LABELS"
          fi

      - name: Add welcome comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          AUTHOR="${{ github.event.issue.user.login }}"
          
          gh issue comment $ISSUE_NUMBER --body "ğŸ‘‹ Merhaba @$AUTHOR!

          Issue'nuz iÃ§in teÅŸekkÃ¼rler. Ekibimiz en kÄ±sa sÃ¼rede inceleyecek.

          ---

          **YararlÄ± BaÄŸlantÄ±lar:**
          - ğŸ“– [KatkÄ± Rehberi](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)
          - ğŸ—ºï¸ [GeliÅŸtirme PlanÄ±](https://github.com/${{ github.repository }}/blob/main/DEVELOPMENT_ROADMAP.md)
          - ğŸ› [Bilinen Hatalar](https://github.com/${{ github.repository }}/blob/main/KNOWN_ISSUES.md)

          > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."

  # ===========================================================================
  # Auto Assign Based on Labels
  # ===========================================================================
  auto-assign:
    name: Auto Assign Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled'

    steps:
      - name: Assign based on label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL="${{ github.event.label.name }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Ã–ncelik etiketlerine gÃ¶re otomatik atama
          case "$LABEL" in
            "priority: high"|"security"|"critical")
              gh issue edit $ISSUE_NUMBER --add-assignee "${{ env.OWNER }}"
              echo "Assigned to ${{ env.OWNER }} due to high priority"
              ;;
            "bug")
              # Bug'lar iÃ§in proje sahibine bildirim
              gh issue comment $ISSUE_NUMBER --body "ğŸ› Bu bug yÃ¼ksek Ã¶ncelikli olarak iÅŸaretlendi. @${{ env.OWNER }} inceleyecek."
              ;;
          esac

  # ===========================================================================
  # Stale Issue Reminder
  # ===========================================================================
  stale-reminder:
    name: Stale Issue Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Find and remind stale issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 7 gÃ¼nden eski, aÃ§Ä±k ve in-progress olmayan issue'larÄ± bul
          STALE_ISSUES=$(gh issue list \
            --repo ${{ github.repository }} \
            --state open \
            --json number,title,updatedAt,labels,assignees \
            --jq '[.[] | select(.labels | map(.name) | contains(["in-progress"]) | not) | select((now - (.updatedAt | fromdateiso8601)) > 604800)] | .[0:5]')
          
          if [ "$STALE_ISSUES" != "[]" ] && [ -n "$STALE_ISSUES" ]; then
            echo "Found stale issues: $STALE_ISSUES"
            
            # Her stale issue iÃ§in hatÄ±rlatma yorumu ekle
            echo "$STALE_ISSUES" | jq -r '.[].number' | while read ISSUE_NUM; do
              if [ -n "$ISSUE_NUM" ]; then
                gh issue comment $ISSUE_NUM --body "â° **HatÄ±rlatma**: Bu issue 7 gÃ¼nden fazla sÃ¼redir gÃ¼ncellenmedi.

                - EÄŸer hala Ã¼zerinde Ã§alÄ±ÅŸÄ±yorsanÄ±z, lÃ¼tfen \`in-progress\` etiketi ekleyin
                - EÄŸer artÄ±k gerekli deÄŸilse, lÃ¼tfen kapatÄ±n
                - EÄŸer yardÄ±ma ihtiyacÄ±nÄ±z varsa, \`help wanted\` etiketi ekleyin

                > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."
              fi
            done
          fi

  # ===========================================================================
  # Priority Escalation
  # ===========================================================================
  priority-escalation:
    name: Priority Escalation
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Escalate old high priority issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 3 gÃ¼nden eski high priority issue'larÄ± bul
          OLD_HIGH_PRIORITY=$(gh issue list \
            --repo ${{ github.repository }} \
            --state open \
            --label "priority: high" \
            --json number,title,updatedAt \
            --jq '[.[] | select((now - (.updatedAt | fromdateiso8601)) > 259200)] | .[0:3]')
          
          if [ "$OLD_HIGH_PRIORITY" != "[]" ] && [ -n "$OLD_HIGH_PRIORITY" ]; then
            echo "$OLD_HIGH_PRIORITY" | jq -r '.[].number' | while read ISSUE_NUM; do
              if [ -n "$ISSUE_NUM" ]; then
                gh issue comment $ISSUE_NUM --body "ğŸš¨ **Acil Dikkat Gerekiyor!**

                Bu yÃ¼ksek Ã¶ncelikli issue 3 gÃ¼nden fazla sÃ¼redir Ã§Ã¶zÃ¼lmedi.

                @${{ env.OWNER }} lÃ¼tfen durumu kontrol edin.

                > ğŸ¤– Bu mesaj otomatik olarak gÃ¶nderildi."
              fi
            done
          fi
