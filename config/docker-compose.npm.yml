version: '3.9'

services:
  # Nginx Proxy Manager - Reverse Proxy ve SSL YÃ¶netimi
  nginx_proxy_manager:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: habernexus_npm
    restart: unless-stopped
    
    ports:
      - '80:80'      # HTTP
      - '443:443'    # HTTPS
      - '81:81'      # Admin Panel
    
    environment:
      TZ: "Europe/Istanbul"
      # SQLite Database (Default)
      DB_SQLITE_FILE: "/data/database.sqlite"
      
      # Uncomment for PostgreSQL
      # DB_POSTGRES_HOST: 'postgres'
      # DB_POSTGRES_PORT: '5432'
      # DB_POSTGRES_USER: 'npm'
      # DB_POSTGRES_PASSWORD: '${NPM_DB_PASSWORD}'
      # DB_POSTGRES_NAME: 'npm'
      
      # Uncomment for MySQL/MariaDB
      # DB_MYSQL_HOST: 'mysql'
      # DB_MYSQL_PORT: '3306'
      # DB_MYSQL_USER: 'npm'
      # DB_MYSQL_PASSWORD: '${NPM_DB_PASSWORD}'
      # DB_MYSQL_NAME: 'npm'
    
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
    
    networks:
      - habernexus_network
    
    depends_on:
      - app
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:81/api/v2/nginx/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    labels:
      com.example.description: "Nginx Proxy Manager for HaberNexus"

  # PostgreSQL Database (Optional - for NPM)
  # Uncomment if using PostgreSQL for NPM
  # postgres_npm:
  #   image: postgres:16-alpine
  #   container_name: habernexus_postgres_npm
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: 'npm'
  #     POSTGRES_PASSWORD: '${NPM_DB_PASSWORD}'
  #     POSTGRES_DB: 'npm'
  #   volumes:
  #     - postgres_npm_data:/var/lib/postgresql/data
  #   networks:
  #     - habernexus_network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U npm"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # MySQL/MariaDB Database (Optional - for NPM)
  # Uncomment if using MySQL/MariaDB for NPM
  # mysql_npm:
  #   image: 'jc21/mariadb-aria:latest'
  #   container_name: habernexus_mysql_npm
  #   restart: unless-stopped
  #   environment:
  #     MYSQL_ROOT_PASSWORD: '${NPM_DB_PASSWORD}'
  #     MYSQL_DATABASE: 'npm'
  #     MYSQL_USER: 'npm'
  #     MYSQL_PASSWORD: '${NPM_DB_PASSWORD}'
  #     MARIADB_AUTO_UPGRADE: '1'
  #   volumes:
  #     - mysql_npm_data:/var/lib/mysql
  #   networks:
  #     - habernexus_network
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  npm_data:
    driver: local
  npm_letsencrypt:
    driver: local
  # postgres_npm_data:
  #   driver: local
  # mysql_npm_data:
  #   driver: local

networks:
  habernexus_network:
    driver: bridge
