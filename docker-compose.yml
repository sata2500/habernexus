# HaberNexus v10.9 - Complete Docker Compose Configuration
# Includes: Django App, PostgreSQL, Redis, Celery, Caddy, Cloudflare Tunnel
# Deployment: Cloudflare Tunnel + Caddy (Automatic HTTPS)
# Updated: December 2025 - Modern Docker best practices applied

services:
  # ============================================================================
  # REVERSE PROXY & TUNNEL
  # ============================================================================

  # Caddy - Reverse Proxy with Automatic HTTPS
  caddy:
    build:
      context: .
      dockerfile: caddy/Dockerfile
    container_name: habernexus_caddy
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
    
    networks:
      - habernexus_network
    
    depends_on:
      app:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    labels:
      com.habernexus.description: "Caddy Reverse Proxy with Automatic HTTPS"
      com.habernexus.service: "caddy"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Cloudflare Tunnel - Secure Connection
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: habernexus_cloudflared
    restart: unless-stopped
    
    command: tunnel run
    
    volumes:
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      - ~/.cloudflared:/root/.cloudflared:ro
    
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    
    networks:
      - habernexus_network
    
    depends_on:
      caddy:
        condition: service_healthy
    
    labels:
      com.habernexus.description: "Cloudflare Tunnel for Secure Connection"
      com.habernexus.service: "cloudflared"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # CORE SERVICES
  # ============================================================================

  # PostgreSQL - Primary Database
  postgres:
    image: postgres:16-alpine
    container_name: habernexus_postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: "${DB_NAME:-habernexus}"
      POSTGRES_USER: "${DB_USER:-habernexus_user}"
      POSTGRES_PASSWORD: "${DB_PASSWORD:-change-me-in-production}"
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: "Europe/Istanbul"
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    networks:
      - habernexus_network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-habernexus_user} -d ${DB_NAME:-habernexus}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    labels:
      com.habernexus.description: "PostgreSQL Database for HaberNexus"
      com.habernexus.service: "postgres"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis - Cache and Message Broker
  redis:
    image: redis:7-alpine
    container_name: habernexus_redis
    restart: unless-stopped
    
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
    
    volumes:
      - redis_data:/data
    
    networks:
      - habernexus_network
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    labels:
      com.habernexus.description: "Redis Cache and Message Broker"
      com.habernexus.service: "redis"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # DJANGO APPLICATION
  # ============================================================================

  # Django Application Server
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    container_name: habernexus_app
    restart: unless-stopped
    user: "1000:1000"
    
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             gunicorn habernexus_config.wsgi:application
             --bind 0.0.0.0:8000
             --workers 4
             --threads 2
             --worker-class gthread
             --worker-tmp-dir /dev/shm
             --access-logfile -
             --error-logfile -
             --capture-output
             --enable-stdio-inheritance"
    
    expose:
      - "8000"
    
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DATABASE_URL=postgresql://${DB_USER:-habernexus_user}:${DB_PASSWORD:-change-me}@postgres:5432/${DB_NAME:-habernexus}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - TZ=Europe/Istanbul
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    
    volumes:
      - static_files:/app/staticfiles
      - media_files:/app/media
    
    networks:
      - habernexus_network
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      com.habernexus.description: "Django Application Server"
      com.habernexus.service: "app"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # BACKGROUND TASKS
  # ============================================================================

  # Celery Worker
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: habernexus_celery
    restart: unless-stopped
    user: "1000:1000"
    
    command: >
      celery -A habernexus_config worker
      --loglevel=info
      --concurrency=4
      --max-tasks-per-child=1000
      --prefetch-multiplier=1
    
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DATABASE_URL=postgresql://${DB_USER:-habernexus_user}:${DB_PASSWORD:-change-me}@postgres:5432/${DB_NAME:-habernexus}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - TZ=Europe/Istanbul
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    
    networks:
      - habernexus_network
    
    depends_on:
      app:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "celery", "-A", "habernexus_config", "inspect", "ping", "-d", "celery@$$HOSTNAME"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 30s
    
    labels:
      com.habernexus.description: "Celery Worker for Background Tasks"
      com.habernexus.service: "celery"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Beat - Task Scheduler
  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: habernexus_celery_beat
    restart: unless-stopped
    user: "1000:1000"
    
    command: >
      celery -A habernexus_config beat
      --loglevel=info
      --scheduler django_celery_beat.schedulers:DatabaseScheduler
    
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DATABASE_URL=postgresql://${DB_USER:-habernexus_user}:${DB_PASSWORD:-change-me}@postgres:5432/${DB_NAME:-habernexus}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - TZ=Europe/Istanbul
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    
    networks:
      - habernexus_network
    
    depends_on:
      app:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    
    labels:
      com.habernexus.description: "Celery Beat Task Scheduler"
      com.habernexus.service: "celery_beat"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Flower - Celery Monitoring
  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: habernexus_flower
    restart: unless-stopped
    user: "1000:1000"
    
    command: >
      celery -A habernexus_config flower
      --port=5555
      --broker=redis://redis:6379/0
      --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    
    expose:
      - "5555"
    
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - TZ=Europe/Istanbul
    
    networks:
      - habernexus_network
    
    depends_on:
      celery:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    labels:
      com.habernexus.description: "Flower Celery Monitoring Tool"
      com.habernexus.service: "flower"
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  habernexus_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  static_files:
    driver: local
  media_files:
    driver: local
